<div class="habits-container">
  <!-- Header -->
  <div class="habits-header">
    <h1 class="page-title">Habits</h1>

    <button mat-raised-button color="primary" (click)="goToNewHabit()">
      + Add New Habit
    </button>
  </div>

  <!-- Loading / empty / error states -->
  <div *ngIf="loading" class="info-text">
    Loading your habits...
  </div>

  <div *ngIf="!loading && habits?.length === 0" class="info-text">
    You don‚Äôt have any habits yet. Create your first habit to get started!
  </div>

  <div *ngIf="errorMsg" class="error-text">
    {{ errorMsg }}
  </div>

  <!-- Habits grid -->
  <div class="habits-grid" *ngIf="!loading && habits && habits.length">
    <mat-card
      class="habit-card"
      *ngFor="let habit of habits"
      (click)="openHabit(habit)"
    >
      <!-- Top row: title + actions -->
      <div class="habit-card-header">
        <div>
          <!-- title + done-today badge -->
          <div class="habit-title-row">
            <h2 class="habit-title">{{ habit.title }}</h2>

            <span *ngIf="isCompletedToday(habit)" class="today-badge">
              <mat-icon>check_circle</mat-icon>
              Done today
            </span>
          </div>

          <!-- üîî Reminder info row (only if reminderEnabled is true) -->
          <div class="habit-reminder-row" *ngIf="habit.reminderEnabled">
            <mat-icon
              class="reminder-icon"
              matTooltip="Email reminder enabled"
            >
              notifications_active
            </mat-icon>
            <span class="reminder-text">
              Reminder at
              {{ habit.reminderTime || habit.timeOfDay || 'set time' }}
            </span>
          </div>

          <!-- Description -->
          <p class="habit-description" *ngIf="habit.description">
            {{ habit.description }}
          </p>
        </div>

        <div class="habit-actions">
          <button
            mat-icon-button
            (click)="openHabit(habit); $event.stopPropagation()"
            matTooltip="View details"
          >
            <mat-icon>open_in_new</mat-icon>
          </button>

          <button
            mat-icon-button
            color="warn"
            (click)="openDeleteHabitDialog(habit, $event)"
            matTooltip="Delete habit"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>

      <!-- Chips row: modern Pending + Streak -->
      <div class="habit-meta">
        <mat-chip-listbox>
          <!-- Pending / Done chip -->
          <mat-chip
            class="status-chip"
            [ngClass]="
              isCompletedToday(habit) ? 'chip-done' : 'chip-pending'
            "
          >
            <mat-icon>
              {{
                isCompletedToday(habit)
                  ? 'check_circle'
                  : 'radio_button_unchecked'
              }}
            </mat-icon>
            {{ isCompletedToday(habit) ? 'Done Today' : 'Pending' }}
          </mat-chip>

          <!-- Streak chip -->
          <mat-chip class="status-chip chip-streak">
            <mat-icon>trending_up</mat-icon>
            {{ getStreak(habit) }}-day streak
          </mat-chip>
        </mat-chip-listbox>
      </div>

      <!-- Footer: last completed + mark done button -->
      <div class="habit-footer">
        <div class="habit-status">
          Last completed:
          <ng-container
            *ngIf="habit.completedDates as completedDates; else neverTpl"
          >
            {{ completedDates[completedDates.length - 1] | date: 'MMM d' }}
          </ng-container>
          <ng-template #neverTpl>Never</ng-template>
        </div>

        <button
          mat-raised-button
          color="primary"
          class="mark-done-btn"
          [disabled]="isCompletedToday(habit)"
          (click)="markDone(habit, $event)"
        >
          {{
            isCompletedToday(habit) ? 'Done for today' : 'Mark done today'
          }}
        </button>
      </div>
    </mat-card>
  </div>

  <!-- üî• Inline Material delete-confirm dialog -->
  <ng-template #deleteHabitDialog>
    <div class="hf-dialog">
      <div class="hf-dialog-icon">‚ö†Ô∏è</div>

      <h2 class="hf-dialog-title">Delete this habit?</h2>

      <p class="hf-dialog-message">
        This habit and its progress will be removed permanently.
      </p>

      <div class="hf-dialog-actions">
        <button
          mat-button
          class="hf-btn-secondary"
          (click)="closeDeleteHabitDialog()"
        >
          Cancel
        </button>

        <button
          mat-raised-button
          color="warn"
          class="hf-btn-danger"
          (click)="confirmDeleteHabit()"
        >
          Delete habit
        </button>
      </div>
    </div>
  </ng-template>
</div>
